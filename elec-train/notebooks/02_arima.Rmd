---
title: "02 - ARIMA Models"
author: "Time Series Analysis"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: flatly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Introduction

This notebook implements ARIMA (AutoRegressive Integrated Moving Average) models for electricity consumption forecasting. We will explore different ARIMA configurations and compare their performance.

# Load Required Libraries

```{r libraries}
if (!require("forecast")) install.packages("forecast")
if (!require("tseries")) install.packages("tseries")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("Metrics")) install.packages("Metrics")

library(forecast)
library(tseries)
library(ggplot2)
library(Metrics)
```

# Load Data

```{r load-data}
load("../data/elec_data.RData")

cat("Training set length:", length(train_ts), "\n")
cat("Validation set length:", length(validation_ts), "\n")
cat("Forecast horizon:", horizon, "\n")
```

# Stationarity Analysis

```{r stationarity}
# Augmented Dickey-Fuller test
adf_result <- adf.test(train_ts, alternative = "stationary")
cat("ADF Test p-value:", adf_result$p.value, "\n")

if (adf_result$p.value < 0.05) {
  cat("Series is stationary (reject null hypothesis)\n")
} else {
  cat("Series is non-stationary (fail to reject null hypothesis)\n")
}

# ACF and PACF plots
par(mfrow = c(2, 1))
acf(train_ts, lag.max = 200, main = "ACF of Training Data")
pacf(train_ts, lag.max = 200, main = "PACF of Training Data")
par(mfrow = c(1, 1))
```

# Differencing Analysis

```{r differencing}
# Check number of differences needed
ndiffs_result <- ndiffs(train_ts)
cat("Recommended number of differences:", ndiffs_result, "\n")

# Seasonal differences
nsdiffs_result <- nsdiffs(train_ts)
cat("Recommended number of seasonal differences:", nsdiffs_result, "\n")

# Apply differencing if needed
if (ndiffs_result > 0) {
  train_diff <- diff(train_ts, differences = ndiffs_result)
  
  # Re-check stationarity
  adf_diff <- adf.test(train_diff, alternative = "stationary")
  cat("ADF Test on differenced series - p-value:", adf_diff$p.value, "\n")
  
  # ACF/PACF of differenced series
  par(mfrow = c(2, 1))
  acf(train_diff, lag.max = 100, main = "ACF of Differenced Series")
  pacf(train_diff, lag.max = 100, main = "PACF of Differenced Series")
  par(mfrow = c(1, 1))
}
```

# ARIMA Model

```{r arima-model}
# Based on stationarity analysis:
# - ndiffs = 0 (no regular differencing needed)
# - nsdiffs = 1 (seasonal differencing needed - handled in SARIMA notebook)
# 
# For pure ARIMA (non-seasonal), we use d=0 since series is stationary
# Based on PACF analysis showing significant autocorrelation up to lag 5,
# we use ARIMA(5,0,0) - consistent with our SARIMA analysis

arima_model <- Arima(train_ts, order = c(5, 0, 0))

cat("ARIMA(5,0,0) Summary:\n")
summary(arima_model)
```

# Forecast

```{r forecast}
# Generate forecast
arima_forecast <- forecast(arima_model, h = horizon)

# Plot forecast
plot(arima_forecast, main = "ARIMA(5,0,0) Forecast")
```

# Model Evaluation

```{r evaluation}
actual <- as.numeric(validation_ts)
predicted <- as.numeric(arima_forecast$mean)

# Calculate error metrics
test_rmse <- rmse(actual, predicted)
test_mae <- mae(actual, predicted)
test_mape <- mape(actual, predicted) * 100

cat("=== ARIMA(5,0,0) Validation Metrics ===", "\n")
cat("RMSE:", round(test_rmse, 2), "\n")
cat("MAE:", round(test_mae, 2), "\n")
cat("MAPE:", round(test_mape, 2), "%\n")
```

# Residual Diagnostics

```{r residuals}
checkresiduals(arima_model)

# Ljung-Box test
lb_test <- Box.test(residuals(arima_model), lag = 20, type = "Ljung-Box")
cat("\nLjung-Box test p-value:", lb_test$p.value, "\n")

if (lb_test$p.value < 0.05) {
  cat("Note: Residuals show significant autocorrelation.\n")
  cat("This is expected for non-seasonal ARIMA on seasonal data.\n")
  cat("See SARIMA notebook (03_sarima.Rmd) for proper seasonal modeling.\n")
}
```

# Visualization

```{r visualization, fig.width=12, fig.height=6}
plot_data <- data.frame(
  Time = 1:horizon,
  Actual = actual,
  Forecast = predicted
)

ggplot(plot_data, aes(x = Time)) +
  geom_line(aes(y = Actual, color = "Actual"), linewidth = 1) +
  geom_line(aes(y = Forecast, color = "ARIMA(5,0,0)"), linewidth = 1, linetype = "dashed") +
  labs(title = "ARIMA(5,0,0) Forecast vs Actual",
       subtitle = "Note: Pure ARIMA without seasonal component",
       x = "Time (15-min intervals)",
       y = "Power (kW)",
       color = "") +
  theme_minimal()
```

# Save Results

```{r save-results}
arima_results <- list(
  model = arima_model,
  metrics = data.frame(
    Model = "ARIMA(5,0,0)",
    RMSE = test_rmse,
    MAE = test_mae,
    MAPE = test_mape
  ),
  best_model_name = "ARIMA(5,0,0)",
  best_rmse = test_rmse,
  best_forecast = predicted
)

save(arima_results, file = "../data/arima_results.RData")
cat("Results saved to ../data/arima_results.RData\n")
```

# Session Info

```{r session-info}
sessionInfo()
```
