---
title: "07 - SVM (Support Vector Machine)"
author: "Time Series Analysis"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: flatly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Introduction

This notebook implements Support Vector Machine (SVM) for electricity consumption forecasting with:
- Feature selection based on significant PACF lags
- Temperature as exogenous variable
- RBF kernel with hyperparameter tuning

# Load Required Libraries

```{r libraries}
if (!require("e1071")) install.packages("e1071")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("Metrics")) install.packages("Metrics")
if (!require("forecast")) install.packages("forecast")
if (!require("tidyr")) install.packages("tidyr")

library(e1071)
library(ggplot2)
library(Metrics)
library(forecast)
library(tidyr)
```

# Load Data

```{r load-data}
load("../data/elec_data.RData")

cat("Training set length:", length(train_ts), "\n")
cat("Validation set length:", length(validation_ts), "\n")
cat("Training temperature length:", length(train_temp_ts), "\n")
cat("Validation temperature length:", length(validation_temp_ts), "\n")
cat("Forecast horizon:", horizon, "\n")
```

# Feature Selection Based on PACF

```{r pacf-analysis, fig.width=12, fig.height=6}
# Analyze PACF to identify significant lags
ggtsdisplay(train_ts, lag.max = 200, main = "Training Data - ACF/PACF")
```

Based on PACF analysis, significant lags are:
- **1, 37, 61**: Short-term dependencies  
- **96, 97**: Daily seasonality (lag 96 = 24h)
- **192**: Two-day pattern

```{r define-lags}
# Significant lags from PACF
lags <- c(1, 37, 61, 96, 97, 192)

cat("Selected lags:", paste(lags, collapse = ", "), "\n")
cat("Max lag:", max(lags), "\n")
```

# Data Preparation

```{r data-prep}
# Function to create features from lagged values + temperature
create_features <- function(power_data, temp_data, lags) {
  n <- length(power_data)
  max_lag <- max(lags)
  m <- n - max_lag
  
  # Create lagged features matrix
  X <- matrix(NA, nrow = m, ncol = length(lags))
  colnames(X) <- paste0("lag_", lags)
  
  for (i in seq_along(lags)) {
    lag <- lags[i]
    X[, i] <- power_data[(max_lag - lag + 1):(n - lag)]
  }
  
  # Add temperature feature
  temperature <- temp_data[(max_lag + 1):n]
  X <- cbind(X, temperature = temperature)
  
  # Target
  y <- power_data[(max_lag + 1):n]
  
  return(list(X = as.data.frame(X), y = y, max_lag = max_lag))
}

# Create training data
train_power <- as.numeric(train_ts)
train_temp <- as.numeric(train_temp_ts)

feat_data <- create_features(train_power, train_temp, lags)

cat("Feature matrix shape:", nrow(feat_data$X), "x", ncol(feat_data$X), "\n")
cat("Features:", names(feat_data$X), "\n")
```

# Hyperparameter Tuning

```{r hyperparameter-tuning}
cat("Running hyperparameter grid search for SVM...\n\n")

# Grid of parameters for RBF kernel
params_grid <- expand.grid(
  cost = c(1, 10, 100),
  gamma = c(0.001, 0.01, 0.1),
  epsilon = c(0.01, 0.1, 0.2)
)

actual <- as.numeric(validation_ts)
test_temp <- as.numeric(validation_temp_ts)

# Store results
tuning_results <- data.frame()
best_rmse <- Inf
best_params <- NULL

for (i in 1:nrow(params_grid)) {
  params <- params_grid[i, ]
  
  # Train SVM
  svm_model <- svm(
    x = feat_data$X,
    y = feat_data$y,
    kernel = "radial",
    cost = params$cost,
    gamma = params$gamma,
    epsilon = params$epsilon
  )
  
  # Recursive forecasting
  pred <- numeric(horizon)
  newpower <- train_power
  
  for (j in 1:horizon) {
    # Build features for prediction
    current_n <- length(newpower)
    features <- sapply(lags, function(lag) newpower[current_n - lag + 1])
    features <- c(features, test_temp[j])
    names(features) <- c(paste0("lag_", lags), "temperature")
    
    pred[j] <- predict(svm_model, as.data.frame(t(features)))
    newpower <- c(newpower, pred[j])
  }
  
  # Calculate RMSE
  rmse_val <- sqrt(mean((pred - actual)^2))
  
  tuning_results <- rbind(tuning_results, data.frame(
    cost = params$cost,
    gamma = params$gamma,
    epsilon = params$epsilon,
    RMSE = rmse_val
  ))
  
  if (rmse_val < best_rmse) {
    best_rmse <- rmse_val
    best_params <- params
  }
  
  cat(sprintf("cost=%d, gamma=%.3f, eps=%.2f -> RMSE=%.2f\n",
              params$cost, params$gamma, params$epsilon, rmse_val))
}

cat("\n=== BEST PARAMETERS ===\n")
print(best_params)
cat("Best RMSE:", round(best_rmse, 2), "\n")
```

# Train Final Model

```{r final-model}
# Train with best parameters
final_model <- svm(
  x = feat_data$X,
  y = feat_data$y,
  kernel = "radial",
  cost = best_params$cost,
  gamma = best_params$gamma,
  epsilon = best_params$epsilon
)

summary(final_model)
```

# Final Forecast

```{r final-forecast}
# Recursive forecasting with best model
final_pred <- numeric(horizon)
newpower <- train_power

for (j in 1:horizon) {
  current_n <- length(newpower)
  features <- sapply(lags, function(lag) newpower[current_n - lag + 1])
  features <- c(features, test_temp[j])
  names(features) <- c(paste0("lag_", lags), "temperature")
  
  final_pred[j] <- predict(final_model, as.data.frame(t(features)))
  newpower <- c(newpower, final_pred[j])
}

# Metrics
test_rmse <- rmse(actual, final_pred)
test_mae <- mae(actual, final_pred)
test_mape <- mape(actual, final_pred) * 100

cat("\n=== VALIDATION SET METRICS ===\n")
cat("RMSE:", round(test_rmse, 2), "\n")
cat("MAE:", round(test_mae, 2), "\n")
cat("MAPE:", round(test_mape, 2), "%\n")
```

# Comparison: With vs Without Temperature

```{r comparison-temp}
cat("\n=== COMPARISON: With vs Without Temperature ===\n\n")

# Train model WITHOUT temperature
X_no_temp <- feat_data$X[, -ncol(feat_data$X)]  # Remove temperature column

model_no_temp <- svm(
  x = X_no_temp,
  y = feat_data$y,
  kernel = "radial",
  cost = best_params$cost,
  gamma = best_params$gamma,
  epsilon = best_params$epsilon
)

# Forecast without temperature
pred_no_temp <- numeric(horizon)
newpower <- train_power

for (j in 1:horizon) {
  current_n <- length(newpower)
  features <- sapply(lags, function(lag) newpower[current_n - lag + 1])
  names(features) <- paste0("lag_", lags)
  
  pred_no_temp[j] <- predict(model_no_temp, as.data.frame(t(features)))
  newpower <- c(newpower, pred_no_temp[j])
}

cat("RMSE WITH temperature:", round(test_rmse, 2), "\n")
cat("RMSE WITHOUT temperature:", round(rmse(actual, pred_no_temp), 2), "\n")
```

# Visualization

```{r visualization, fig.width=12, fig.height=6}
plot_data <- data.frame(
  Time = 1:horizon,
  Actual = actual,
  `SVM (with temp)` = final_pred,
  `SVM (no temp)` = pred_no_temp,
  check.names = FALSE
)

plot_long <- plot_data %>%
  pivot_longer(cols = -Time, names_to = "Model", values_to = "Power")

ggplot(plot_long, aes(x = Time, y = Power, color = Model, linetype = Model)) +
  geom_line(linewidth = 0.8) +
  scale_color_manual(values = c("Actual" = "black", 
                                "SVM (with temp)" = "purple",
                                "SVM (no temp)" = "violet")) +
  scale_linetype_manual(values = c("Actual" = "solid", 
                                   "SVM (with temp)" = "dashed",
                                   "SVM (no temp)" = "dotted")) +
  labs(title = "SVM Forecast Comparison",
       x = "Time (15-min intervals)",
       y = "Power (kW)") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

# Daily Pattern

```{r daily-pattern, fig.width=12, fig.height=6}
time_of_day <- seq(0, 23.75, by = 0.25)

plot_daily <- data.frame(
  Hour = time_of_day,
  Actual = actual,
  Forecast = final_pred
)

ggplot(plot_daily, aes(x = Hour)) +
  geom_line(aes(y = Actual, color = "Actual"), linewidth = 1) +
  geom_line(aes(y = Forecast, color = "SVM"), linewidth = 1, linetype = "dashed") +
  scale_x_continuous(breaks = seq(0, 24, by = 4)) +
  labs(title = "SVM Forecast - Daily Pattern",
       x = "Hour of Day",
       y = "Power (kW)",
       color = "") +
  theme_minimal()
```

# Save Results

```{r save-results}
svm_results <- list(
  model = final_model,
  tuning_results = tuning_results,
  best_params = list(
    cost = best_params$cost,
    gamma = best_params$gamma,
    epsilon = best_params$epsilon,
    lags = lags
  ),
  metrics = data.frame(
    Model = "SVM (selected lags + temp)",
    RMSE = test_rmse,
    MAE = test_mae,
    MAPE = test_mape
  ),
  best_model_name = "SVM (selected lags + temp)",
  best_rmse = test_rmse,
  best_forecast = final_pred
)

save(svm_results, file = "../data/svm_results.RData")
cat("Results saved to ../data/svm_results.RData\n")
```

# Session Info

```{r session-info}
sessionInfo()
```
